version: 1.0.{build}
cache:
    - c:\mysql-5.7.9-win32
platform: x86
build:
  parallel: true
image: Visual Studio 2019
clone_depth: 1
init:
- ps: ''
environment:
  BOOST_VER: x32-1.73
  BOOST_ROOT: C:\Libraries\boost_1_73_0
  BOOST_LIBS: C:\Libraries\boost_1_73_0\lib32-msvc-14.2
  MYSQL_HOME: C:\mysql-5.7.31-win32
  ADDRESS_MODEL: 32
  OPENSSL_ROOT_DIR: C:\OpenSSL-Win32
build_script:

- pwsh: | 
        if (Test-Path "c:\mysql-5.7.31-win32") {
            echo "using mysql-5.7.31-win32 from cache"
        }
        else
        {
        echo "downloading mysql-5.7.31-win32"

        Invoke-WebRequest "https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.31-win32.zip" -OutFile mysql-5.7.31-win32.zip

        echo "installing mysql-5.7.31-win32.zip"

        7z x -y mysql-5.7.31-win32.zip -oC:\
        }
        $env:INCLUDE = "C:\mysql-5.7.31-win32\include;" + $env:INCLUDE
        $env:LIB     = "C:\mysql-5.7.31-win32\lib;" + $env:LIB

        Get-ChildItem C:\mysql-5.7.31-win32

        Get-ChildItem C:\Libraries

- cmd: >-
    chcp 65001

    git config user.email "appveyor@build.bot" && git config user.name "AppVeyor"

    git tag -a -m "AppVeyor build" init

    md build && cd build

    cmake -G"Visual Studio 16 2019" -A win32 -DTOOLS=True -DWITH_WARNINGS:BOOL="0" -DELUNA:BOOL="1" -DCMAKE_CXX_FLAGS=" /utf-8 /DWIN32 /D_WINDOWS /W3 /GR /EHsc" -DCMAKE_C_FLAGS=" /utf-8 /DWIN32 /D_WINDOWS /W3" -DWITH_COREDEBUG=0 -DUSE_COREPCH=1 -DUSE_SCRIPTPCH=1 -DTOOLS=1 -DSERVERS=1 -DNOJEM=0 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_CXX_FLAGS=" /utf-8 /DWIN32 /D_WINDOWS /W3 /GR /EHsc" -DCMAKE_C_FLAGS=" /utf-8 /DWIN32 /D_WINDOWS /W3" -DCMAKE_INSTALL_PREFIX=check_install -DBUILD_TESTING=1 -DWITH_WARNINGS:BOOL="0" -DELUNA:BOOL="1" -DMYSQL_INCLUDE_DIR:PATH="C:\mysql-5.7.31-win32\include" -DMYSQL_LIBRARY:FILEPATH="C:\mysql-5.7.31-win32/libmysql.lib" ..

    "%programfiles(x86)%\Microsoft Visual Studio\2019\Community\MSBuild\Current\Bin\MsBuild.exe" /p:source-charset=utf-8 /nologo /m:2 /p:Configuration=RelWithDebInfo /p:Platform="win32" /verbosity:minimal /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll" "TrinityCore.sln"

    cd bin\RelWithDebInfo\

    copy "C:\mysql-5.7.31-win32\lib\libmysql.dll" libmysql.dll

    copy "%OPENSSL_ROOT_DIR%\ssleay32.dll" ssleay32.dll

    copy "%OPENSSL_ROOT_DIR%\libeay32.dll" libeay32.dll

    cd ..

    7z a -t7z TrinityCoreWin64SymbolsVS2019.7z .\RelWithDebInfo\* -mx=9 -ms=200m -mf -mhc -mhcf -mmt -r

    del /F /Q /S "RelWithDebInfo\*.pdb" > NUL

    7z a -t7z TrinityCoreWin64VS2019.7z .\RelWithDebInfo\* -mx=9 -ms=200m -mf -mhc -mhcf -mmt -r

test: off
artifacts:
- path: build\bin\TrinityCoreWin64SymbolsVS2019.7z
  name: TrinityCoreWin64SymbolsVS2019

- path: build\bin\TrinityCoreWin64VS2019.7z
  name: TrinityCoreWin64VS2019

